<!-- Compare Header -->
<div class="mb-4" data-controller="article-preferences"
     data-article-preferences-show-colors-value="true"
     data-article-preferences-show-highlight-value="true"
     data-article-preferences-show-references-value="true">
  <div class="bg-gradient-to-r from-[var(--accent-500)]/5 to-[var(--accent-500)]/10 dark:from-[var(--accent-500)]/10 dark:to-[var(--accent-500)]/20 rounded-xl p-4 border border-[var(--accent-500)]/20 dark:border-[var(--accent-500)]/30">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <h1 class="text-xl font-bold text-gray-900 dark:text-[var(--accent-500)]">
        <%= I18n.locale == :fr ? "Comparaison NL / FR" : "Vergelijking NL / FR" %>
      </h1>
      
      <%# View preference toggles %>
      <div class="flex flex-wrap items-center gap-2">
        <%# Toggle colored references %>
        <button type="button"
              class="btn-toggle-active"
              data-action="click->article-preferences#toggleColors"
              data-colors-toggle
              title="<%= t('articles.hide_colors_tooltip') %>">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
          </svg>
          <%= t('articles.hide_colors') %>
        </button>
        
        <%# Toggle reference highlighting %>
        <button type="button"
              class="btn-toggle-active"
              data-action="click->article-preferences#toggleHighlight"
              data-highlight-toggle
              title="<%= t('articles.hide_highlight_tooltip') %>">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.243 3.343a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-9 9a1 1 0 01-.39.242l-3.5 1.167a1 1 0 01-1.264-1.264l1.167-3.5a1 1 0 01.242-.39l9-9zM14 6.414L6.414 14l-.667 2 .253.253 2-.667L15.586 8 14 6.414zM16 5l1.586 1.586L19 5.172 17.414 3.586 16 5z"/>
            <path d="M3 19h6v2H3v-2z"/>
          </svg>
          <%= t('articles.hide_highlight') %>
        </button>
        
        <%# Toggle references visibility %>
        <button type="button"
              class="btn-toggle-active"
              data-action="click->article-preferences#toggleReferences"
              data-references-toggle
              title="<%= t('articles.hide_references_tooltip') %>">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
          </svg>
          <%= t('articles.hide_references') %>
        </button>
        
        <span class="text-gray-300 dark:text-gray-600">|</span>
        
        <%# Copy all button %>
        <button type="button"
              class="btn-toggle-active"
              data-controller="clipboard"
              data-action="click->clipboard#copyCompareArticles"
              data-clipboard-copied-label-value="<%= I18n.locale == :fr ? 'Copié!' : 'Gekopieerd!' %>"
              title="<%= I18n.locale == :fr ? 'Copier tous les articles (NL/FR)' : 'Kopieer alle artikelen (NL/FR)' %>">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
          </svg>
          <%= I18n.locale == :fr ? 'Copier tout' : 'Kopieer alles' %>
        </button>
        
        <%# Copy all (citation) button %>
        <button type="button"
              class="btn-toggle-active"
              data-controller="clipboard"
              data-action="click->clipboard#copyCompareArticlesCitation"
              data-clipboard-copied-label-value="<%= I18n.locale == :fr ? 'Copié!' : 'Gekopieerd!' %>"
              title="<%= I18n.locale == :fr ? 'Copier tous les articles sans références (NL/FR)' : 'Kopieer alle artikelen zonder referenties (NL/FR)' %>">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
          </svg>
          <%= I18n.locale == :fr ? 'Copier (citation)' : 'Kopieer (citaat)' %>
        </button>
        
        <%# Export to Word button %>
        <%= link_to export_word_compare_law_path(@law),
                    class: "btn-toggle-active",
                    title: I18n.locale == :fr ? 'Exporter vers Word (NL/FR)' : 'Exporteer naar Word (NL/FR)' do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
          Word
        <% end %>
        
        <%# Export to Word (citation) button %>
        <%= link_to export_word_compare_law_path(@law, citation: true),
                    class: "btn-toggle-active",
                    title: I18n.locale == :fr ? 'Exporter vers Word sans références (NL/FR)' : 'Exporteer naar Word zonder referenties (NL/FR)' do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
          <%= I18n.locale == :fr ? 'Word (citation)' : 'Word (citaat)' %>
        <% end %>
        
        <%# Print button %>
        <button type="button"
              class="btn-toggle-active"
              onclick="window.print()"
              title="<%= I18n.locale == :fr ? 'Imprimer' : 'Afdrukken' %>">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"/>
          </svg>
          <%= I18n.locale == :fr ? 'Imprimer' : 'Afdrukken' %>
        </button>
      </div>
      
      <div class="flex items-center gap-3">
        <%= link_to law_path(@law, language_id: I18n.locale == :fr ? 2 : 1),
                    class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-lg text-[var(--accent-700)] dark:text-[var(--accent-300)] hover:bg-[var(--accent-500)]/10 border border-[var(--accent-500)]/20 transition-colors duration-150" do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span><%= I18n.locale == :fr ? "Retour" : "Terug" %></span>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Column Headers -->
<div class="flex gap-2 mb-2">
  <div class="flex-1 bg-[var(--accent-500)]/20 dark:bg-[var(--accent-500)]/30 px-3 py-2 rounded-lg">
    <h2 class="text-sm font-bold text-gray-800 dark:text-[var(--accent-300)] uppercase tracking-wide">Nederlands (NL)</h2>
  </div>
  <div class="flex-1 bg-[var(--accent-500)]/20 dark:bg-[var(--accent-500)]/30 px-3 py-2 rounded-lg">
    <h2 class="text-sm font-bold text-gray-800 dark:text-[var(--accent-300)] uppercase tracking-wide">Français (FR)</h2>
  </div>
</div>

<!-- Title Row -->
<div class="flex gap-2 mb-2">
  <div class="flex-1 bg-white dark:bg-navy rounded-lg border border-gray-200 dark:border-[var(--accent-500)]/30 p-3">
    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1"><%= t(:title, default: 'Titel') %></div>
    <div class="text-sm font-medium text-gray-900 dark:text-gray-100">
      <%= @law_nl.present? ? print_multiline(@law_nl.title, skip_paragraphs: true) : '-' %>
    </div>
  </div>
  <div class="flex-1 bg-white dark:bg-navy rounded-lg border border-gray-200 dark:border-[var(--accent-500)]/30 p-3">
    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Titre</div>
    <div class="text-sm font-medium text-gray-900 dark:text-gray-100">
      <%= @law_fr.present? ? print_multiline(@law_fr.title, skip_paragraphs: true) : '-' %>
    </div>
  </div>
</div>

<!-- Document Info Row -->
<div class="flex gap-2 mb-2">
  <div class="flex-1 bg-white dark:bg-navy rounded-lg border border-gray-200 dark:border-[var(--accent-500)]/30 p-3">
    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1"><%= t(:document_info, default: 'Document Info') %></div>
    <div class="text-xs text-gray-700 dark:text-gray-300 space-y-1">
      <% if @law_nl.present? %>
        <div><span class="font-medium">Numac:</span> <%= @law_nl.numac %></div>
        <div><span class="font-medium">Datum:</span> <%= @law_nl.date %></div>
        <% if @law_nl.justel.present? %><div><span class="font-medium">Justel:</span> <%= link_to @law_nl.justel, @law_nl.justel, target: '_blank', class: 'text-[var(--accent-600)] hover:underline' %></div><% end %>
        <% if @law_nl.mon.present? && @law_nl.mon != 'N/A' %><div><span class="font-medium">Staatsblad:</span> <%= link_to 'Bekijken', @law_nl.mon, target: '_blank', class: 'text-[var(--accent-600)] hover:underline' %></div><% end %>
      <% else %>
        <span class="italic text-gray-400">-</span>
      <% end %>
    </div>
  </div>
  <div class="flex-1 bg-white dark:bg-navy rounded-lg border border-gray-200 dark:border-[var(--accent-500)]/30 p-3">
    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Info du document</div>
    <div class="text-xs text-gray-700 dark:text-gray-300 space-y-1">
      <% if @law_fr.present? %>
        <div><span class="font-medium">Numac:</span> <%= @law_fr.numac %></div>
        <div><span class="font-medium">Date:</span> <%= @law_fr.date %></div>
        <% if @law_fr.justel.present? %><div><span class="font-medium">Justel:</span> <%= link_to @law_fr.justel, @law_fr.justel, target: '_blank', class: 'text-[var(--accent-600)] hover:underline' %></div><% end %>
        <% if @law_fr.mon.present? && @law_fr.mon != 'N/A' %><div><span class="font-medium">Moniteur:</span> <%= link_to 'Voir', @law_fr.mon, target: '_blank', class: 'text-[var(--accent-600)] hover:underline' %></div><% end %>
      <% else %>
        <span class="italic text-gray-400">-</span>
      <% end %>
    </div>
  </div>
</div>

<!-- Build arrays for TOC and articles -->
<%
  articles_nl_arr = @articles_nl.to_a
  articles_fr_arr = @articles_fr.to_a
  max_articles = [articles_nl_arr.size, articles_fr_arr.size].max
  
  # Build TOC entries from section headings (LNK type)
  toc_entries_nl = []
  toc_entries_fr = []
  articles_nl_arr.each_with_index do |article, idx|
    if article&.article_type == 'LNK'
      heading_text = strip_tags(article.article_text).split(/\n|----------/).first.to_s.strip
      level = section_heading_level(heading_text)
      toc_entries_nl << { text: heading_text, level: level, index: idx }
    end
  end
  articles_fr_arr.each_with_index do |article, idx|
    if article&.article_type == 'LNK'
      heading_text = strip_tags(article.article_text).split(/\n|----------/).first.to_s.strip
      level = section_heading_level(heading_text)
      toc_entries_fr << { text: heading_text, level: level, index: idx }
    end
  end
%>

<!-- TOC Section (same layout as Document Info) -->
<% if toc_entries_nl.any? || toc_entries_fr.any? %>
<div class="flex gap-2 mb-2">
  <div class="flex-1 bg-white dark:bg-navy rounded-lg border border-gray-200 dark:border-[var(--accent-500)]/30 p-3">
    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1"><%= I18n.locale == :fr ? 'Table des matières' : 'Inhoud' %></div>
    <div class="text-xs text-gray-700 dark:text-gray-300 space-y-1 max-h-32 overflow-y-auto">
      <% toc_entries_nl.each do |entry| %>
        <a href="#compare-row-<%= entry[:index] %>" 
           class="block text-[var(--accent-600)] dark:text-[var(--accent-400)] hover:underline truncate <%= entry[:level] > 1 ? 'pl-' + [(entry[:level] - 1) * 2, 4].min.to_s : '' %>"
           title="<%= entry[:text] %>">
          <%= truncate(entry[:text], length: 50) %>
        </a>
      <% end %>
    </div>
  </div>
  <div class="flex-1 bg-white dark:bg-navy rounded-lg border border-gray-200 dark:border-[var(--accent-500)]/30 p-3">
    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1"><%= I18n.locale == :fr ? 'Table des matières' : 'Inhoud' %></div>
    <div class="text-xs text-gray-700 dark:text-gray-300 space-y-1 max-h-32 overflow-y-auto">
      <% toc_entries_fr.each do |entry| %>
        <a href="#compare-row-<%= entry[:index] %>" 
           class="block text-[var(--accent-600)] dark:text-[var(--accent-400)] hover:underline truncate <%= entry[:level] > 1 ? 'pl-' + [(entry[:level] - 1) * 2, 4].min.to_s : '' %>"
           title="<%= entry[:text] %>">
          <%= truncate(entry[:text], length: 50) %>
        </a>
      <% end %>
    </div>
  </div>
</div>
<% end %>

<!-- Main content area -->
<div>
    <!-- Articles Section Header -->
<div class="flex gap-2 mb-2 mt-4">
  <div class="flex-1 bg-gray-100 dark:bg-gray-800 px-3 py-2 rounded-lg">
    <div class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Tekst (<%= @articles_nl.size %>)</div>
  </div>
  <div class="flex-1 bg-gray-100 dark:bg-gray-800 px-3 py-2 rounded-lg">
    <div class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Texte (<%= @articles_fr.size %>)</div>
  </div>
</div>

<!-- Articles - aligned by index with paragraph-level alignment -->
<%
  # Helper to split article text into paragraphs for line-by-line comparison
  def split_into_paragraphs(text)
    return [] if text.blank?
    # Split on double newlines, <br> tags, or paragraph boundaries
    # Preserve the HTML structure but split into logical units
    text.to_s
        .gsub(/<br\s*\/?>/i, "\n")
        .gsub(/<\/p>\s*<p[^>]*>/i, "\n\n")
        .split(/\n\n+/)
        .map(&:strip)
        .reject(&:blank?)
  end
%>

<% max_articles.times do |i| %>
  <% article_nl = articles_nl_arr[i] %>
  <% article_fr = articles_fr_arr[i] %>
  
  <div id="compare-row-<%= i %>" class="mb-2 scroll-mt-16">
    <%# Check if this is a section heading (LNK type) %>
    <% is_heading_nl = article_nl&.article_type == 'LNK' %>
    <% is_heading_fr = article_fr&.article_type == 'LNK' %>
    
    <% if is_heading_nl || is_heading_fr %>
      <%# Section headings - show side by side without paragraph splitting %>
      <div class="flex gap-2">
        <div class="flex-1 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-[var(--accent-500)]/20 p-2 text-xs" data-article-scope>
          <% if article_nl.present? %>
            <% heading_text = strip_tags(article_nl.article_text).split(/\n|----------/).first.to_s.strip %>
            <% level = section_heading_level(heading_text) %>
            <div class="<%= level <= 2 ? 'font-bold text-gray-800 dark:text-gray-200' : 'font-semibold text-gray-700 dark:text-gray-300' %> <%= level == 1 ? 'text-sm' : 'text-xs' %>">
              <%= heading_text %>
            </div>
          <% else %>
            <span class="text-gray-400 italic">-</span>
          <% end %>
        </div>
        <div class="flex-1 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-[var(--accent-500)]/20 p-2 text-xs" data-article-scope>
          <% if article_fr.present? %>
            <% heading_text = strip_tags(article_fr.article_text).split(/\n|----------/).first.to_s.strip %>
            <% level = section_heading_level(heading_text) %>
            <div class="<%= level <= 2 ? 'font-bold text-gray-800 dark:text-gray-200' : 'font-semibold text-gray-700 dark:text-gray-300' %> <%= level == 1 ? 'text-sm' : 'text-xs' %>">
              <%= heading_text %>
            </div>
          <% else %>
            <span class="text-gray-400 italic">-</span>
          <% end %>
        </div>
      </div>
    <% else %>
      <%# Regular articles - split into paragraphs for line-by-line comparison %>
      <%
        # Get article title row
        title_nl = article_nl&.article_title.to_s.strip
        title_fr = article_fr&.article_title.to_s.strip
        
        # Get article text and split into paragraphs
        text_nl = article_nl&.article_text.to_s
        text_fr = article_fr&.article_text.to_s
        
        # Split by common paragraph delimiters
        paras_nl = text_nl.split(/(?:<br\s*\/?>\s*){2,}|(?:\n\s*){2,}/i).map(&:strip).reject(&:blank?)
        paras_fr = text_fr.split(/(?:<br\s*\/?>\s*){2,}|(?:\n\s*){2,}/i).map(&:strip).reject(&:blank?)
        
        # If no paragraph splits found, treat the whole text as one paragraph
        paras_nl = [text_nl] if paras_nl.empty? && text_nl.present?
        paras_fr = [text_fr] if paras_fr.empty? && text_fr.present?
        
        max_paras = [paras_nl.size, paras_fr.size].max
      %>
      
      <div class="bg-white dark:bg-navy rounded border border-gray-200 dark:border-[var(--accent-500)]/20 overflow-hidden">
        
        <%# Paragraph rows - aligned line by line %>
        <% max_paras.times do |p_idx| %>
          <% para_nl = paras_nl[p_idx] %>
          <% para_fr = paras_fr[p_idx] %>
          <div class="flex gap-0 <%= p_idx < max_paras - 1 ? 'border-b border-gray-50 dark:border-gray-800' : '' %>">
            <div class="flex-1 p-2 text-xs text-gray-700 dark:text-gray-300 leading-relaxed border-r border-gray-100 dark:border-gray-700" data-article-scope>
              <% if para_nl.present? %>
                <%= process_article_with_references(para_nl) %>
              <% else %>
                <span class="text-gray-300 dark:text-gray-600">-</span>
              <% end %>
            </div>
            <div class="flex-1 p-2 text-xs text-gray-700 dark:text-gray-300 leading-relaxed" data-article-scope>
              <% if para_fr.present? %>
                <%= process_article_with_references(para_fr) %>
              <% else %>
                <span class="text-gray-300 dark:text-gray-600">-</span>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <%# Empty state %>
        <% if max_paras == 0 %>
          <div class="flex gap-0">
            <div class="flex-1 p-2 text-xs text-gray-400 italic border-r border-gray-100 dark:border-gray-700">-</div>
            <div class="flex-1 p-2 text-xs text-gray-400 italic">-</div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<% if @articles_nl.empty? && @articles_fr.empty? %>
  <div class="flex gap-2">
    <div class="flex-1 bg-white dark:bg-navy rounded-lg border border-gray-200 dark:border-[var(--accent-500)]/30 p-4 text-center">
      <p class="text-gray-500 dark:text-gray-400 italic text-sm">
        <%= I18n.locale == :fr ? "Aucun article disponible" : "Geen artikelen beschikbaar" %>
      </p>
    </div>
    <div class="flex-1 bg-white dark:bg-navy rounded-lg border border-gray-200 dark:border-[var(--accent-500)]/30 p-4 text-center">
      <p class="text-gray-500 dark:text-gray-400 italic text-sm">
        <%= I18n.locale == :fr ? "Aucun article disponible" : "Geen artikelen beschikbaar" %>
      </p>
    </div>
  </div>
<% end %>

  </div><!-- End main content area -->
